<html>
		<script src="jquery-1.4.2.js"></script>
		<script src="jquery.ba-bbq.js"></script>
		<script src="agent.js"></script>
		<script src="file-chooser.js" ></script>

        <script>

            //extract session key


            var params = document.location.hash.split("|")
            // 1st param is "#"
            var sessionId = params[1];
            var albumId = params[2];
            var path = params[3];



            document.location.hash = "#" + path


            setInterval(refreshUploader, 3000)


            function refreshUploader()
            {
                agent.getUploadStatsAsync(function(json) {
                    updateUploader(json);
                });
            }

            function updateUploader(json)
            {
                var html="<div style='width:" + (json.length+1) * 200 + "'>"
                for(var i=0;i<json.length;i++)
                {
                    var file = json[i];


                    html += "<div style='text-align:middle; width:200px; height:150px; border:0px; float:left'>";
                    html += "<center><img height='100' src='" + agent.getThumbnailUrl(file.path) + "'></center>";
                    html += "<br>";

                    if(file.isRunning || file.isDone)
                    {
                        html += "<center><div style='border:1px solid black;height:8px;width:150px'>";
                        html += "<div style='float:left;border-top:4px solid blue; border-bottom:4px solid blue; height:0px;width:" + ((150 * file.bytesUploaded)/file.size) + "px'></div>"
                        html += "</div></center>"
                    }
                    html += "<center>" + file.name + "</center>";
                    html += "<center>[<a href=\"javascript:cancelUpload('" + file.path + "')\">cancel upload</a>]</center>"; 

                    if(file.error!="")
                    {
                        html += "<center>ERROR: " + file.error + "</center>"
                    }

                    html += "</div>";


                    //[{"bytesUploaded": 0, "path": "/Users/hopemeng/Desktop/Cambodia/DSC_0153.JPG", "isRunning": true, "isDone": false, "size": 4600850}]
                }
                html += "</div>";
                $("#uploader").html(html);

                if(justAddedToUpload)
                {
                    $("#uploader").scrollLeft(json.length*200);
                    justAddedToUpload=false
                }
                
            }

            var justAddedToUpload=false
            
            function upload(path)
            {
                justAddedToUpload=true
                agent.uploadAsync(path, albumId, function(response) {
                    refreshFileChooser();
                    refreshUploader();
                });
            }

            function cancelUpload(path)
            {
                agent.cancelUploadAsync(path, function(response) {
                    refreshFileChooser();
                    refreshUploader();
                });
            }




        </script>


	<body style="font-family:Verdana; font-size:12px">

		<div id="path"></div> 
		<div id="container" style="overflow:auto; width:100%; height:65%; border:1px black solid"></div>
        <br>
        <div id="uploader" style="overflow:auto; width:100%; height:170px; border:1px black solid"></div>
	</body>
</html>