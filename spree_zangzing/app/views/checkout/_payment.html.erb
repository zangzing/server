<style>
    div.inner input[type=text], div.inner select { width: 90%; }
    .hidden { display: none; }
    #checkout-summary{
        position: absolute;
        top: 22px;
        right: 0;
    }
    div#checkout #checkout_form_payment select#order_bill_address_id {
        width: 300px;
    }
</style>


<legend><%= t("payment_information") %></legend>
<%= render :partial =>'creditcard_wallet', :locals => { :order => @order }%>

<fieldset id="payment">
  <% method = @order.default_payment_method %>
  <%=hidden_field_tag "order[payments_attributes][][payment_method_id]",  method.id%>
  <fieldset>
    <div class="inner">
      <%= render "checkout/payment/#{method.method_type}", :payment_method => method %>
      <%unless current_user %>
          <% clean_guest_checkout_email( @order ) %>
          <p id="email" class="field">
            <%= form.label :email, t("email") %>
            <%= form.text_field :email, :class => 'required' %><span class="req">*</span>
          <div>( <%=t("email_needed")%> )</div>
          </p>
      <%end%>
    </div>
  </fieldset>
  <br style='clear:both;' />

  <fieldset>
    <legend><%= t("billing_address") %></legend>
    <p>
      <label for="order_use_shipping_as_billing"><%= t("use_shipping_address") %></label>
      <%= check_box_tag 'order[use_shipping_as_billing]', '1', (!( (@order.bill_address && @order.bill_address.empty?) && @order.ship_address.empty?) && @order.bill_address.eql?(@order.ship_address)) %>
    </p>

    <fieldset id="billing">
    <%= render :partial =>'addressbook', :locals => { :form => form,
                                                      :order => @order,
                                                      :address_kind => 'bill_address',
                                                      :button_text => "Use This Address" } %>

    <legend><%= t("Enter a new Billing Address")%></legend>
    <div class="inner">
      <%= form.fields_for :bill_address do |bill_form| %>
          <%= render :partial =>'address_fields', :locals => { :f => bill_form,
                                                               :address => @order.bill_address } %>
      <% end %>
    </div>
    </fieldset>
    <fieldset id="shipping" class="hidden">
      <%= render :partial =>'address_display', :locals => { :address => @order.ship_address,:label =>"" } %>
    </fieldset>

  </fieldset>

</fieldset>

<hr class="space" />
<div class="form-buttons">
  <input type="submit" class="continue button primary" value="<%=t("save_and_continue") %>" />
</div>

<script type="text/javascript">
  $('#order_use_shipping_as_billing').click(function(){
      if( this.checked ){
        $('#billing').addClass('hidden');
        $('#shipping').removeClass('hidden');
        }else{
        $('#billing').removeClass('hidden');
        $('#shipping').addClass('hidden');
      }
  })

</script>